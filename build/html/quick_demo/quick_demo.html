

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3. 快速上手指南 &mdash; Knight_doc V3.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=eb26d1a0"></script>
      <script src="../_static/doctools.js?v=888ff710"></script>
      <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4. 量化使用指南" href="../user_guides_base/quant.html" />
    <link rel="prev" title="2. 使用指南综述" href="../overview/overview.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Knight_doc
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Knight 工具链</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../doc_info/doc_info.html">1. 修改记录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/overview.html">2. 使用指南综述</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3. 快速上手指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#knight-demo">3.1. Knight demo介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">3.2. 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">3.3. 开发环境准备</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#docker">3.3.1. 准备docker环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">3.3.2. 加载镜像文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">3.3.3. 查看镜像</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">3.3.4. 运行镜像</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#knight">3.4. Knight命令说明</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id7">3.5. 模型转换配置文件示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id8">3.6. 模型转换命令执行</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id9">3.7. 仿真命令执行</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id10">3.7.1. 输入数据准备</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">3.7.2. 仿真模型推理</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">3.7.3. 输出数据后处理</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id13">3.7.4. 性能评估</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id14">3.8. 板端运行</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id15">3.8.1. 相关文件说明</a></li>
<li class="toctree-l3"><a class="reference internal" href="#demo">3.8.2. demo交叉编译</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id16">3.8.3. 板端环境搭建及部署</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id17">3.8.3.1. 板端环境准备</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id18">3.8.3.2. 板端运行</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id23">3.9. 功能特性说明</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id24">3.9.1. 数据预处理说明</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id25">3.9.1.1. 预处理配置说明</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id26">3.9.1.2. 多输入模型配置说明</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id27">3.9.2. 模型输出说明</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id28">3.9.2.1. 后处理裁剪</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id29">3.9.2.2. 增加反量化层</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id30">3.9.3. 模型输入说明</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id31">3.9.3.1. 归一化放入模型首层</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user_guides_base/quant.html">4. 量化使用指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guides_base/compile.html">5. 编译仿真性能分析使用指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guides_base/sdk.html">6. SDK使用指南</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">附录</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../faq/quant_faq.html">1. 量化工具FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../op/op.html">2. 算子支持列表</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Knight_doc</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">3. </span>快速上手指南</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/quick_demo/quick_demo.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1><span class="section-number">3. </span>快速上手指南<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h1>
<p>为便于客户更直观、更快速的了解清微智能骑士工具链 <code class="docutils literal notranslate"><span class="pre">TS.Knight</span></code> 的用法，将自己的业务神经网络模型快速的在清微智能芯片产品上部署，特针对工具链各模块（ <code class="docutils literal notranslate"><span class="pre">Knight</span></code> 量化工具、 <code class="docutils literal notranslate"><span class="pre">Knight</span>
<span class="pre">RNE</span></code> 编译器、 <code class="docutils literal notranslate"><span class="pre">Knigh</span> <span class="pre">RNE</span></code> 模拟器、 <code class="docutils literal notranslate"><span class="pre">Knight</span> <span class="pre">RNE</span></code> 性能分析器）提供结合语音、图像业务的快速上手用例。同时对这些用例进行讲解，以期帮助用户达到快速上手的目的。</p>
<p>这些用例结合具体业务只用于演示工具链的典型使用流程，使用的数据量较少，所以精度不具有参考价值，不代表工具链的实际精度效果。用例中的一些脚本，比如语音、图像数据的预处理，
客户可借鉴，如果有类似业务场景可在其基础上进行修改。客户如果想发挥出工具链的最大能力、更灵活的使用、应用到更复杂的场景，还需仔细阅读 <code class="docutils literal notranslate"><span class="pre">TS.Knight</span></code> 工具链各模块相应的使用指南文档。</p>
<p><strong>名词解释</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>名词</strong></p></th>
<th class="head"><p><strong>说明</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Knight</p></td>
<td><p>清微骑士工具链英文名称</p></td>
</tr>
<tr class="row-odd"><td><p>QAT</p></td>
<td><p>Quantization Aware
Training，量化感知训练</p></td>
</tr>
<tr class="row-even"><td><p>RNE</p></td>
<td><p>可重构神经网络加速引擎</p></td>
</tr>
<tr class="row-odd"><td><p>Finetune</p></td>
<td><p>微调</p></td>
</tr>
<tr class="row-even"><td><p>IR定点模型</p></td>
<td><p>中间表示模型，指
Caffe定点模型或ONNX定点模型</p></td>
</tr>
</tbody>
</table>
<section id="knight-demo">
<h2><span class="section-number">3.1. </span>Knight demo介绍<a class="headerlink" href="#knight-demo" title="Permalink to this heading"></a></h2>
</section>
<section id="id2">
<h2><span class="section-number">3.2. </span>简介<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h2>
<p>Knight包含部署AI模型所需的全套工具链，包括模型转换、模拟器仿真、运行时库等功能。</p>
<figure class="align-center">
<img alt="pipeline" src="../_images/quick1.png" />
</figure>
</section>
<section id="id3">
<h2><span class="section-number">3.3. </span>开发环境准备<a class="headerlink" href="#id3" title="Permalink to this heading"></a></h2>
<p>本章介绍使用Knight工具链前所需要完成的开发环境准备。</p>
<section id="docker">
<h3><span class="section-number">3.3.1. </span>准备docker环境<a class="headerlink" href="#docker" title="Permalink to this heading"></a></h3>
<p>Knight支持容器部署的方式，用户需要保证已安装docker环境，docker版本大于等于19.03。</p>
</section>
<section id="id4">
<h3><span class="section-number">3.3.2. </span>加载镜像文件<a class="headerlink" href="#id4" title="Permalink to this heading"></a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>load<span class="w"> </span>-i<span class="w"> </span>ts.knight-&lt;version&gt;.tar.gz
</pre></div>
</div>
</section>
<section id="id5">
<h3><span class="section-number">3.3.3. </span>查看镜像<a class="headerlink" href="#id5" title="Permalink to this heading"></a></h3>
<p>查看已加载的镜像。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>images
</pre></div>
</div>
<figure class="align-center">
<img alt="pipeline" src="../_images/image7.png" />
</figure>
</section>
<section id="id6">
<h3><span class="section-number">3.3.4. </span>运行镜像<a class="headerlink" href="#id6" title="Permalink to this heading"></a></h3>
<p>执行以下命令启动docker 镜像。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>run<span class="w"> </span>--name<span class="o">=</span>knight_docker<span class="w"> </span>-v<span class="w"> </span>localhost_dir:/data<span class="w"> </span>-it<span class="w"> </span>ts.knight:
xxx<span class="w"> </span>/bin/bash
</pre></div>
</div>
<p>其中 localhost_dir表示宿主目录，即本地需映射到容器内的目录（绝对路径）。</p>
<p>容器启动成功后，在容器内任意目录下均可使用Knight命令，Knight帮助信息页面示例如下所示。</p>
<figure class="align-center">
<img alt="pipeline" src="../_images/image8.png" />
</figure>
</section>
</section>
<section id="knight">
<h2><span class="section-number">3.4. </span>Knight命令说明<a class="headerlink" href="#knight" title="Permalink to this heading"></a></h2>
<p>Knight作为工具链功能的总入口，支持参数如下：</p>
<ul class="simple">
<li><p>-v: 查看Knight工具链版本信息。</p></li>
<li><p>-h/–help: 查看帮助信息。</p></li>
<li><p>-ch/–chip:
配置芯片型号，可调用相应型号下的工具链功能，可选，默认值为TX5368AV200。</p></li>
<li><p>–default-chip:
配置芯片型号-ch/–chip默认值，用户可通过以下命令行配置新的默认值。</p></li>
</ul>
<p>Knight子命令重点说明如下：</p>
<ul class="simple">
<li><p>Knight build
为模型转换命令，包含量化编译操作，用来将浮点模型转换为tsmodel模型部署资源，并完成模型精度比对和模型正确性验证。</p></li>
<li><p>Knight run 为模型仿真命令，用来完成tsmodel的推理运行。</p></li>
<li><p>Knight profiling 为模型性能分析命令，用来评估tsmodel在板端的性能。</p></li>
</ul>
</section>
<section id="id7">
<h2><span class="section-number">3.5. </span>模型转换配置文件示例<a class="headerlink" href="#id7" title="Permalink to this heading"></a></h2>
<p>容器内/TS-KnightDemo/Samples目录下中内置了resnet18和yolov5的配置文件示例，本文以yolov5进行说明，/TS-KnightDemo/Samples/yolov5_config.json内容如下：</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>

<span class="nt">&quot;chip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;TX5336AV200&quot;</span><span class="p">,</span>
<span class="nt">&quot;quant&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="nt">&quot;model&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/TS-KnightDemo/Samples/yolov5s/models/yolov5s.onnx&quot;</span><span class="p">,</span>
<span class="nt">&quot;framework&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;onnx&quot;</span><span class="p">,</span>
<span class="nt">&quot;infer-func&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;infer_common&quot;</span><span class="p">,</span>
<span class="nt">&quot;bit-width&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span>
<span class="nt">&quot;quant-mode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;mse&quot;</span><span class="p">,</span>
<span class="nt">&quot;batch-size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="nt">&quot;run-mode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;quant&quot;</span><span class="p">,</span>
<span class="nt">&quot;iteration&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
<span class="nt">&quot;output-dequant&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="nt">&quot;dump&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="nt">&quot;output-name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/model.24/m.0/Conv_output_0 /model.24/m.1/Conv_output_0</span>
<span class="s2">/model.24/m.2/Conv_output_0&quot;</span><span class="p">,</span>
<span class="nt">&quot;save-dir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/TS-KnightDemo/output/yolov5s/quant&quot;</span><span class="p">,</span>
<span class="nt">&quot;log-level&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="nt">&quot;user-defined-script&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/opt/Quantize/onnx_examples/infer_common.py&quot;</span><span class="p">,</span>
<span class="nt">&quot;input-configs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;input_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;images&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;quant_data_format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Image&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;data_dir&quot;</span><span class="p">:</span><span class="s2">&quot;/TS-KnightDemo/Samples/yolov5s/data/quant_data/coco/images/val2017&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;color_space&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;RGB&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;mean&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
<span class="w">   </span><span class="nt">&quot;std&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">255.0</span><span class="p">,</span><span class="mf">255.0</span><span class="p">,</span><span class="mf">255.0</span><span class="p">]</span>
<span class="w">   </span><span class="nt">&quot;quantize_input_dtype&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;padding_constant_value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="p">}]</span>
<span class="p">},</span>

<span class="nt">&quot;compile&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="nt">&quot;save-dir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/TS-KnightDemo/output/yolov5s/rne&quot;</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>用户如果需要修改模型，可选择修改以下”quant”中的配置的参数。</p>
<ul class="simple">
<li><p>“model”：用户浮点onnx模型。</p></li>
<li><p>“output-name”：模型输出层，根据实际需求配置，如果不需要裁剪模型后处理，则可不指定。</p></li>
<li><p>“save-dir”:量化的输出路径。</p></li>
<li><p>“infer-func”:量化推理函数，定义在”user-defined-script”指定的脚本中。</p></li>
<li><p>“user-defined-script”：量化自定义脚本。</p></li>
<li><p>“dump”:是否保存量化后的输出数据，需要设置为true,以便后续模型验证流程。</p></li>
<li><p>“input-configs”数据预处理参数参见`章节8.1 &lt;l&gt;`__。</p></li>
</ul>
<p>详细信息请参见 <a class="reference internal" href="../user_guides_base/quant.html"><span class="doc">量化使用指南</span></a></p>
<p>同时可选择修改以下”compile”中的配置的参数：</p>
<ul class="simple">
<li><p>“save-dir”:编译的输出路径，建议和quant.save-dir设置为同级目录。</p></li>
</ul>
<p>详细信息请参见 <a class="reference internal" href="../user_guides_base/compile.html"><span class="doc">编译仿真性能分析使用指南</span></a></p>
<p>在完成模型转换后，可通过以下字段配置自动完成模型验证和精度比对：</p>
<ul class="simple">
<li><p>“disable-compare”：可选，数据类型bool, 取值范围[true, false]</p></li>
<li><p>值为true，表示不进行模型精度对比。</p></li>
<li><p>值为false，默认值，表示在完成模型转换后，调用Knight
compare工具进行量化前后的精度对比。</p></li>
<li><p>“disable-model-check”: 可选，数据类型bool, 取值范围[true, false]</p></li>
<li><p>值为true，表示不进行模型验证；</p></li>
<li><p>值为false，默认值，表示在完成模型转换后，调用model_check.py工具执行模型验证，仅支持NCHW输入数据格式的校验。</p></li>
</ul>
</section>
<section id="id8">
<h2><span class="section-number">3.6. </span>模型转换命令执行<a class="headerlink" href="#id8" title="Permalink to this heading"></a></h2>
<p>以yolov5为例，执行以下命令编译生成tsmodel。</p>
<p>命令行示例参见/TS-KnightDemo/Samples/yolov5_sample.sh</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>Knight<span class="w"> </span>build<span class="w"> </span>--run-config<span class="w"> </span>/TS-KnightDemo/Samples/yolov5_config.json
</pre></div>
</div>
<p>模型转换执行成功后，会在设置的save-dir中保存输出文件，输出目录为 /TS-KnightDemo/output/yolov5s。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>├──yolov5
│<span class="w"> </span>├──<span class="w"> </span>quant
│<span class="w"> </span>│<span class="w"> </span>├──<span class="w"> </span>yolov5s_quantize.onnx<span class="w"> </span><span class="c1">#量化后的模型</span>
│<span class="w"> </span>│<span class="w"> </span>├──<span class="w"> </span>dump<span class="w"> </span><span class="c1">#dump设置为true时，保存浮点模型和量化模型每层的输出数据</span>
│<span class="w"> </span>│<span class="w"> </span>├──<span class="w"> </span>steps<span class="w"> </span><span class="c1">#量化过程保存的onnx模型，用于调试</span>
│<span class="w"> </span>│<span class="w"> </span>├──<span class="w"> </span>inputs<span class="w"> </span><span class="c1">#用于模拟器输入的二进制bin数据，仅保存最后一条数据</span>
│<span class="w"> </span>│<span class="w"> </span>├──<span class="w"> </span>log
│<span class="w"> </span>├──<span class="w"> </span>rne
│<span class="w"> </span>│<span class="w"> </span>├──<span class="w"> </span>yolov5s_quantize_r.tsmodel<span class="w"> </span><span class="c1">#芯片指令和权重部署文件</span>
│<span class="w"> </span>│<span class="w"> </span>├──<span class="w"> </span>yolov5s_quantize_r.cfg<span class="w"> </span><span class="c1">#芯片指令部署文件</span>
│<span class="w"> </span>│<span class="w"> </span>├──<span class="w"> </span>yolov5s_quantize_r.weight<span class="w"> </span><span class="c1">#芯片权重部署资源</span>
│<span class="w"> </span>│<span class="w"> </span>├──<span class="w"> </span>log
</pre></div>
</div>
</section>
<section id="id9">
<h2><span class="section-number">3.7. </span>仿真命令执行<a class="headerlink" href="#id9" title="Permalink to this heading"></a></h2>
<section id="id10">
<h3><span class="section-number">3.7.1. </span>输入数据准备<a class="headerlink" href="#id10" title="Permalink to this heading"></a></h3>
<p>在使用模拟器推理tsmodel之前，需要准备输入bin文件，以下命令将bus.jpg进行前处理，并保存为bin文件。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python3<span class="w"> </span>/TS-KnightDemo/Samples/yolov5s/pysrc/yolov5_onnx.py<span class="w"> </span><span class="se">\</span>
--input<span class="w"> </span>/TS-KnightDemo/Samples/yolov5s/data/test_data/bus.jpg<span class="w"> </span><span class="se">\</span>
--outpath<span class="w"> </span>/TS-KnightDemo/output/yolov5s/rne<span class="w"> </span>--pre_processing
</pre></div>
</div>
</section>
<section id="id11">
<h3><span class="section-number">3.7.2. </span>仿真模型推理<a class="headerlink" href="#id11" title="Permalink to this heading"></a></h3>
<p>执行Knight run命令，输入bin 文件完成推理。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>Knight<span class="w"> </span>--chip<span class="w"> </span>TX5336AV200<span class="w"> </span>run<span class="w"> </span><span class="se">\</span>
--input<span class="w"> </span>/TS-KnightDemo/output/yolov5s/rne/model_input.bin<span class="w"> </span><span class="se">\</span>
--model<span class="w"> </span>/TS-KnightDemo/output/yolov5s/rne/yolov5s_quantize_r.tsmodel<span class="w"> </span><span class="se">\</span>
--save-dir<span class="w"> </span>/TS-KnightDemo/output/yolov5s/rne<span class="w"> </span>-fmt<span class="w"> </span>nchw
</pre></div>
</div>
<p>执行该命令后，将模拟器推理tsmodel的输出数据保存为txt文件，示例如下：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>result-_model.24_m.0_Conv_output_0_p.txt
result-_model.24_m.1_Conv_output_0_p.txt
result-_model.24_m.2_Conv_output_0_p.txt
</pre></div>
</div>
</section>
<section id="id12">
<h3><span class="section-number">3.7.3. </span>输出数据后处理<a class="headerlink" href="#id12" title="Permalink to this heading"></a></h3>
<p>执行以下脚本，完成针对输出数据的后处理，得到最终的计算结果。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python3<span class="w"> </span>/TS-KnightDemo/Samples/yolov5s/pysrc/yolov5_onnx.py<span class="w"> </span><span class="se">\</span>
--input<span class="w"> </span>/TS-KnightDemo/output/yolov5s/rne<span class="w"> </span>--outpath<span class="w"> </span>/TS-KnightDemo/output/yolov5s/rne<span class="w"> </span><span class="se">\</span>
--post_processing<span class="w"> </span>--data<span class="w"> </span>/TS-KnightDemo/Samples/yolov5s/data/test_data/bus.jpg
</pre></div>
</div>
<p>执行该命令后，日志显示如下：</p>
<figure class="align-center">
<img alt="pipeline" src="../_images/image9.png" />
</figure>
</section>
<section id="id13">
<h3><span class="section-number">3.7.4. </span>性能评估<a class="headerlink" href="#id13" title="Permalink to this heading"></a></h3>
<p>在没有板端环境条件下，可使用仿真工具评估模型性能。命令如下</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>Knight<span class="w"> </span>profiling<span class="w"> </span>--chip<span class="w"> </span>TX5336AV200<span class="w"> </span>--model
/TS-KnightDemo/output/yolov5/rne/yolov5s_v7.0_quantize_r.tsmodel
--save-dir<span class="w"> </span>/TS-KnightDemo/output/yolov5/rne
</pre></div>
</div>
</section>
</section>
<section id="id14">
<h2><span class="section-number">3.8. </span>板端运行<a class="headerlink" href="#id14" title="Permalink to this heading"></a></h2>
<section id="id15">
<h3><span class="section-number">3.8.1. </span>相关文件说明<a class="headerlink" href="#id15" title="Permalink to this heading"></a></h3>
<p>容器外/TX5368x_TX5339x_TX5335x_Lib/RNE-RT-Lib/samples/rne_yolov5_detection目录为演示yolov5的前处理、推理、后处理的完整流程。</p>
</section>
<section id="demo">
<h3><span class="section-number">3.8.2. </span>demo交叉编译<a class="headerlink" href="#demo" title="Permalink to this heading"></a></h3>
<p>执行如下命令：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>samples/rne_yolov5_detection
make<span class="w"> </span>clean<span class="w"> </span><span class="p">;</span><span class="w"> </span>make<span class="p">;</span>
</pre></div>
</div>
<p>执行成功后，会看到以下信息提示，表示交叉编译成功，生成板端部署资源：
samples/rne_yolov5_detection/build_linux_a53/Release/rne_yolov5_detection.elf。</p>
<figure class="align-center">
<img alt="pipeline" src="../_images/image10.png" />
</figure>
</section>
<section id="id16">
<h3><span class="section-number">3.8.3. </span>板端环境搭建及部署<a class="headerlink" href="#id16" title="Permalink to this heading"></a></h3>
<section id="id17">
<h4><span class="section-number">3.8.3.1. </span>板端环境准备<a class="headerlink" href="#id17" title="Permalink to this heading"></a></h4>
<p>开发板环境的配置及与板端的初始化请参考《TX5368A Linux
SDK安装及升级使用说明_v1.5.pdf》第2章安装、升级TX5368A DEMO板开发环境。</p>
</section>
<section id="id18">
<span id="id19"></span><h4><span class="section-number">3.8.3.2. </span>板端运行<a class="headerlink" href="#id18" title="Permalink to this heading"></a></h4>
<section id="id20">
<h5><span class="section-number">3.8.3.2.1. </span>配置交叉编译环境<a class="headerlink" href="#id20" title="Permalink to this heading"></a></h5>
<p>在RNE-RT-Lib目录下，有settings_path_linux.sh脚本。编辑该脚本将tools_dir设置成gcc-arm-10.2-2020.11-x86_64-arm-none-linux-gnueabihf.tar.xz
解压后的存放路径（最好是绝对路径），之后source一下就可以。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 工作目录：./RNE_RT_Lib</span>
<span class="c1"># 命令</span>
vi<span class="w"> </span>settings_path_linux.sh
<span class="c1"># 编辑’tools_dir=xxxxxx’</span>
...
<span class="c1"># 保存退出</span>
:wq
<span class="c1">#source 是使该文件生效</span>
<span class="nb">source</span><span class="w"> </span>settings_path_linux.sh
</pre></div>
</div>
<figure class="align-center">
<img alt="pipeline" src="../_images/image11.png" />
</figure>
<figure class="align-center">
<img alt="pipeline" src="../_images/image12.png" />
</figure>
</section>
<section id="id21">
<h5><span class="section-number">3.8.3.2.2. </span>打开串口调试工具<a class="headerlink" href="#id21" title="Permalink to this heading"></a></h5>
<p>确保连线正确，然后打开串口调试工具，可以使用SSCOM、SecureCRT或者其他的软件，本示例使用的是ipop,
确保IPOP工具TFTP已配置好服务器路径，确保打开对应的调试串口，确保板端已经进入linux系统。</p>
</section>
<section id="id22">
<h5><span class="section-number">3.8.3.2.3. </span>拷贝部署资源到板端部署<a class="headerlink" href="#id22" title="Permalink to this heading"></a></h5>
<blockquote>
<div><p>把rne_yolov5_detection.elf以及samples/rne_yolov5_detection目录下resource文件夹拷贝到window系统下IPOP工具配置TFTP服务器目录下，</p>
</div></blockquote>
<p>然后执行如下命令：</p>
<p><strong>通过tftp把文件拷贝到板端：</strong></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 命令</span>
tftp<span class="w"> </span>–g<span class="w"> </span>–r<span class="w"> </span>rne_yolov5_detection.elf<span class="w"> </span><span class="m">192</span>.168.1.20
</pre></div>
</div>
<p><strong>注：</strong>板端的连接配置请参考《TX5368A Linux SDK安装及升级使用说明》。</p>
<blockquote>
<div><p><strong>部署模型：</strong></p>
<p>参数说明：
参数1: resource/yolov5s_v7.0_quantize_r.tsmodel
参数2: resource/1.jpg or resource/2.jpg or resource/3.jpg or resource/4.jpg
./rne_yolov5_detection.elf 参数1 参数2</p>
</div></blockquote>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>chmod<span class="w"> </span>+x<span class="w"> </span>rne_yolov5_detection.elf
./rne_yolov5_detection.elf<span class="w"> </span>resource/yolov5s_quantize_r.tsmodel
resource/bus.jpg
</pre></div>
</div>
<p>执行后，可以看到模型运行结果如下图</p>
<figure class="align-center">
<img alt="pipeline" src="../_images/image13.png" />
</figure>
<p>从以上结果可以看出，板端部署运行结果和 <a href="#id32"><span class="problematic" id="id33">`输出数据后处理`__</span></a> 模拟器仿真结果的结果一致。</p>
<p>生成的识别后的图片如下：</p>
<figure class="align-center">
<img alt="pipeline" src="../_images/image14.jpeg" />
</figure>
</section>
</section>
</section>
</section>
<section id="id23">
<h2><span class="section-number">3.9. </span>功能特性说明<a class="headerlink" href="#id23" title="Permalink to this heading"></a></h2>
<section id="id24">
<h3><span class="section-number">3.9.1. </span>数据预处理说明<a class="headerlink" href="#id24" title="Permalink to this heading"></a></h3>
<p>Knight build
支持仅配置json文件加载校准数据集，无需编写python推理脚本，配置示例如下
/TS-KnightDemo/Samples/yolov5s/yolov5s_config.json</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="nt">&quot;chip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;TX5336AV200&quot;</span><span class="p">,</span>
<span class="nt">&quot;quant&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="nt">&quot;model&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/TS-KnightDemo/Samples/yolov5s/models/yolov5s.onnx&quot;</span><span class="p">,</span>
<span class="nt">&quot;framework&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;onnx&quot;</span><span class="p">,</span>
<span class="nt">&quot;infer-func&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;infer_common&quot;</span><span class="p">,</span>
<span class="nt">&quot;bit-width&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span>
<span class="nt">&quot;quant-mode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;mse&quot;</span><span class="p">,</span>
<span class="nt">&quot;batch-size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="nt">&quot;run-mode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;quant&quot;</span><span class="p">,</span>
<span class="nt">&quot;iteration&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
<span class="nt">&quot;output-dequant&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="nt">&quot;dump&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="nt">&quot;output-name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/model.24/m.0/Conv_output_0 /model.24/m.1/Conv_output_0 /model.24/m.2/Conv_output_0&quot;</span><span class="p">,</span>
<span class="nt">&quot;save-dir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/TS-KnightDemo/output/yolov5s/quant&quot;</span><span class="p">,</span>
<span class="nt">&quot;log-level&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="nt">&quot;user-defined-script&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/opt/Quantize/onnx_examples/infer_common.py&quot;</span><span class="p">,</span>
<span class="nt">&quot;input-configs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="p">{</span>
<span class="nt">&quot;input_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;images&quot;</span><span class="p">,</span>
<span class="nt">&quot;quant_data_format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Image&quot;</span><span class="p">,</span>
<span class="nt">&quot;data_dir&quot;</span><span class="p">:</span><span class="s2">&quot;/TS-KnightDemo/Samples/yolov5s/data/quant_data/coco/images/val2017&quot;</span><span class="p">,</span>
<span class="nt">&quot;color_space&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;RGB&quot;</span><span class="p">,</span>
<span class="nt">&quot;mean&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
<span class="nt">&quot;std&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">255.0</span><span class="p">,</span><span class="mf">255.0</span><span class="p">,</span><span class="mf">255.0</span><span class="p">],</span>
<span class="nt">&quot;quantize_input_dtype&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
<span class="nt">&quot;padding_constant_value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}</span>
<span class="p">]</span>
<span class="p">},</span>
<span class="nt">&quot;compile&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="nt">&quot;save-dir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/TS-KnightDemo/output/yolov5s/rne&quot;</span>
<span class="p">}}</span>
</pre></div>
</div>
<section id="id25">
<h4><span class="section-number">3.9.1.1. </span>预处理配置说明<a class="headerlink" href="#id25" title="Permalink to this heading"></a></h4>
<p>quant字段中input-configs用来配置模型不同输入校准的数据类型，以及经过的预处理步骤。其中的字段说明如下</p>
<ul class="simple">
<li><p>input_name: 必选，指ONNX模型的输入tensor名称。</p></li>
<li><p>quant_data_format: 必选，表示校准数据类型,可选范围[“Image”, “Numpy”,
“Bin”]：</p></li>
</ul>
<blockquote>
<div><p>值为Image, 则是图像数据；
值为Numpy, 则是后缀为.npy的numpy数据；
值为Bin, 则是后缀为.bin的bin数据；</p>
</div></blockquote>
<ul class="simple">
<li><p>data_dir: 必选，表示校准数据路径，仅支持配置绝对路径。</p></li>
<li><p>color_space:
可选，在quant_data_format为Image时生效，可选范围[“BGR”,”RGB”,”GRAY”]，默认“BGR”,表示输入图像数据格式为BGR；</p></li>
<li><p>mean: 可选，均值，list形式，与通道数量相同，与std参数同时提供生效；</p></li>
<li><p>std: 可选，标准差，list形式，与通道数量相同，与mean参数同时提供生效；</p></li>
<li><p>quantize_input_dtype:
可选，量化后定点模型输入数据类型，默认为float32，可选范围[“float32”,
“uint8”]；</p></li>
<li><p>padding_constant_value:
可选，int类型，表示是否进行常量补边，默认None，不进行补边，针对yolo系列模型建议设置该参数为0；</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<blockquote>
<div><p>配置input-configs时注意事项：</p>
</div></blockquote>
<ol class="arabic simple">
<li><p>quant.data/ quant.batch-size 不再生效。</p></li>
<li><p>必须按照示例中指定infer-func和user-defined-script。</p></li>
<li><p>padding_constant_value/mean/std/color_space这些参数仅在quant_data_format为Image时生效。</p></li>
<li><p>quant.save-dir 和compile.save-dir 仅支持绝对路径。</p></li>
</ol>
</div>
</section>
<section id="id26">
<h4><span class="section-number">3.9.1.2. </span>多输入模型配置说明<a class="headerlink" href="#id26" title="Permalink to this heading"></a></h4>
<p>input-configs是list结构，多输入则需要分别配置。配置示例如下：</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="nt">&quot;chip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;TX5336AV200&quot;</span><span class="p">,</span>
<span class="nt">&quot;quant&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="nt">&quot;model&quot;</span><span class="p">:</span><span class="s2">&quot;/TS-KnightDemo/Samples/yoloworld/models/yolo-word-v2-s-image.onnx&quot;</span><span class="p">,</span>
<span class="nt">&quot;framework&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;onnx&quot;</span><span class="p">,</span>
<span class="nt">&quot;infer-func&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;infer_common&quot;</span><span class="p">,</span>
<span class="nt">&quot;bit-width&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;8&quot;</span><span class="p">,</span>
<span class="nt">&quot;quant-mode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;mse&quot;</span><span class="p">,</span>
<span class="nt">&quot;run-mode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;quant&quot;</span><span class="p">,</span>
<span class="nt">&quot;dump&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="nt">&quot;save-dir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/TS-KnightDemo/output/yoloworld_v2s/quant&quot;</span><span class="p">,</span>
<span class="nt">&quot;user-defined-script&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/opt/Quantize/onnx_examples/infer_common.py&quot;</span><span class="p">,</span>
<span class="nt">&quot;input-configs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="p">{</span>
<span class="nt">&quot;input_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;images&quot;</span><span class="p">,</span>
<span class="nt">&quot;quant_data_format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Image&quot;</span><span class="p">,</span>
<span class="nt">&quot;data_dir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/TS-KnightDemo/Samples/yoloworld/data/images&quot;</span><span class="p">,</span>
<span class="nt">&quot;color_space&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;RGB&quot;</span><span class="p">,</span>
<span class="nt">&quot;mean&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
<span class="nt">&quot;std&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">255.0</span><span class="p">,</span><span class="mf">255.0</span><span class="p">,</span><span class="mf">255.0</span><span class="p">],</span>
<span class="nt">&quot;quantize_input_dtype&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
<span class="nt">&quot;padding_constant_value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="p">},</span>
<span class="p">{</span>
<span class="nt">&quot;input_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
<span class="nt">&quot;quant_data_format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Numpy&quot;</span><span class="p">,</span>
<span class="nt">&quot;data_dir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/TS-KnightDemo/Samples/yoloworld/data/texts&quot;</span>
<span class="p">}</span>
<span class="p">]</span>
<span class="p">},</span>
<span class="nt">&quot;compile&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="nt">&quot;onnx&quot;</span><span class="p">:</span>
<span class="s2">&quot;/TS-KnightDemo/output/yoloworld_v2s/quant/yolo-word-v2-s-image_quantize.onnx&quot;</span><span class="p">,</span>
<span class="nt">&quot;save-dir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/TS-KnightDemo/output/yoloworld_v2s/rne&quot;</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>对应校准数据目录结构示例如下：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>├──img_data
│<span class="w"> </span>├──<span class="w"> </span>img1.jpg
│<span class="w"> </span>├──<span class="w"> </span>img2.jpg
├──text_data
│<span class="w"> </span>├──<span class="w"> </span>text1.npy
│<span class="w"> </span>├──<span class="w"> </span>text2.npy
</pre></div>
</div>
</section>
</section>
<section id="id27">
<h3><span class="section-number">3.9.2. </span>模型输出说明<a class="headerlink" href="#id27" title="Permalink to this heading"></a></h3>
<section id="id28">
<h4><span class="section-number">3.9.2.1. </span>后处理裁剪<a class="headerlink" href="#id28" title="Permalink to this heading"></a></h4>
<p>output-dequant参数设置设置输出节点名，会按输出名进行裁剪和量化。不同输出节点使用空格分割，yolov5中示例如下：</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;quant&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="nt">&quot;output-name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/model.24/m.0/Conv_output_0 /model.24/m.0/Conv_output_0 model.24/m.0/Conv_output_0&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id29">
<h4><span class="section-number">3.9.2.2. </span>增加反量化层<a class="headerlink" href="#id29" title="Permalink to this heading"></a></h4>
<p>output-dequant表示是否增加反量化，若设置，会在所有输出层算子前增加反量化算子。</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;quant&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="nt">&quot;output-dequant &quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id30">
<h3><span class="section-number">3.9.3. </span>模型输入说明<a class="headerlink" href="#id30" title="Permalink to this heading"></a></h3>
<section id="id31">
<h4><span class="section-number">3.9.3.1. </span>归一化放入模型首层<a class="headerlink" href="#id31" title="Permalink to this heading"></a></h4>
<p>为提升模型板端性能，一般建议将数据预处理中归一化操作放入模型中，配置示例如下：</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;quant&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="nt">&quot;user-defined-script&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/opt/Quantize/onnx_examples/infer_common.py&quot;</span><span class="p">,</span>
<span class="nt">&quot;input-configs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="p">{</span>
<span class="nt">&quot;input_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;images&quot;</span><span class="p">,</span>
<span class="nt">&quot;quant_data_format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Image&quot;</span><span class="p">,</span>
<span class="nt">&quot;data_dir&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/TS-KnightDemo/Samples/yoloworld/data/images&quot;</span><span class="p">,</span>
<span class="nt">&quot;color_space&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;RGB&quot;</span><span class="p">,</span>
<span class="nt">&quot;mean&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
<span class="nt">&quot;std&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">255.0</span><span class="p">,</span><span class="mf">255.0</span><span class="p">,</span><span class="mf">255.0</span><span class="p">],</span>
<span class="nt">&quot;quantize_input_dtype&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
<span class="nt">&quot;padding_constant_value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="p">}]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>input-configs内配置”quantize_input_dtype”取值为uint8时，必须同时和mean/std
配套使用，表示在模型中增加归一化层，设置后，量化后的定点模型输入的数据格式为0~255的整数。</p>
<p>input-config内配置”quantize_input_dtype”后，quant.quantize_input_dtype不生效。</p>
<p>针对多输入模型和自动混合量化场景，quantize_input_dtype/std/mean仅支持配置在input-config内，且仅支持一路配置quantize_input_dtype为uint8。</p>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../overview/overview.html" class="btn btn-neutral float-left" title="2. 使用指南综述" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../user_guides_base/quant.html" class="btn btn-neutral float-right" title="4. 量化使用指南" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright COPYRIGHT© 2024北京清微智能科技有限公司, 保留所有权利。.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>